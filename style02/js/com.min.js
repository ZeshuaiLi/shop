var tools = {
    show_msg: function (info, time) {
        if (typeof layer.tab === "function") {
            layer.msg(info)
        } else {
            layer.open({content: info, skin: "msg", time: time || 2})
        }
    }, show_loading: function (info, time) {
        if (typeof layer.tab === "function") {
            layer.load(2, {time: (time || 15) * 1e3})
        } else {
            layer.open({type: 2, shadeClose: false, content: info || "加载中", time: time || 15})
        }
    }, show_win: function (content) {
        $(content).show()
    }, close_win: function (con) {
        $(con).hide()
    }, close_all: function () {
        layer.closeAll()
    }
};
var Address_List = [];
if (appData.money !== "S$" && appData.money !== "￥") {
    setTimeout(function () {
        $.ajax({
            type: "get", url: "./product/style02/json/" + appData.money + ".json", dataType: "JSON", success: function (data) {
                if (!data.error) {
                    Address_List = data;
                    init_Select(appData.money, "", "", "#city")
                }
            }
        })
    }, 500)
}

function obtianAddress(money, property, city, area) {
    var address_list = [];
    if (property === "#city") {
        if (money === "฿") {
            address_list.push("จังหวัด/ Province")
        }
        if (money === "RM") {
            address_list.push("Province")
        }
        if (money === "NT") {
            address_list.push("城市")
        }
        if (money === "HK") {
            address_list.push("区域")
        }
        if (money === "Rp") {
            address_list.push("Province")
        }
        if (money === "₫") {
            address_list.push("Province")
        }
        for (var i in Address_List) {
            address_list.push(Address_List[i].city)
        }
    } else if (property === "#area") {
        if (money !== "円") {
            if (Address_List && Address_List.length > 0) {
                if (money === "฿") {
                    address_list.push({area: "เมือง"})
                } else if (money === "RM") {
                    address_list.push({area: "City"})
                } else if (money === "NT") {
                    address_list.push({area: "區縣"})
                } else if (money === "HK") {
                    address_list.push({area: "區"})
                } else if (money === "Rp") {
                    address_list.push({area: "City"})
                } else if (money === "₫") {
                    address_list.push({area: "City"})
                }
            }
            for (var i in Address_List) {
                if (Address_List[i].city === city) {
                    for (var j in Address_List[i].area) {
                        address_list.push(Address_List[i].area[j])
                    }
                }
            }
        }
    } else if (!property) {
        if (money === "RM" || money === "฿" || money === "NT") {
            if (Address_List && Address_List.length > 0) {
                if (money !== "NT") {
                    address_list.push({postcode: selestPostcode})
                }
            }
            for (var i in Address_List) {
                if (Address_List[i].city === city) {
                    for (var j in Address_List[i].area) {
                        if (Address_List[i].area[j].area === area) {
                            for (var k in Address_List[i].area[j].postcode) {
                                address_list.push(Address_List[i].area[j].postcode[k])
                            }
                        }
                    }
                }
            }
        }
    }
    return address_list
}

$("#city").change(function () {
    init_Select(appData.money, $("#city").val(), "", "#area")
});
$("#area").change(function () {
    init_Select(appData.money, $("#city").val(), $("#area").val(), "")
});
var codeList, cityList, areaList, postage = 0, list711 = [], listfamily = [];

function init_Select(code, city, area, ele) {
    $("#postage").hide();
    var eleJQ = $(ele);
    eleJQ.empty();
    var selectroad = $("#selectroad");
    selectroad.empty();
    var clientzipcode = $("#clientzipcode");
    clientzipcode.empty();
    var hash = {};
    var address = obtianAddress(code, ele, city, area);
    if (!ele) {
        codeList = address;
        if (appData.money === "NT") {
            var addr_type = $("#address_method input:checked").val();
            if (area && area !== "區縣") {
                if (addr_type === "711") {
                    list711 = codeList.filter(function (item) {
                        return item.type + "" === "2"
                    });
                    if (list711.length === 0) {
                        list711 = [{postcode: "此區域無店鋪,請選擇其他收貨方式", type: 2, road: "此區域無店鋪,請選擇其他收貨方式"}];
                        $("#zipcode_div").hide()
                    } else {
                        list711.unshift({postcode: "請選擇店鋪", type: 2, road: "請選擇街道"});
                        $("#zipcode_div").show()
                    }
                    var road711 = list711.reduce(function (arr, current) {
                        hash[current.road] ? "" : hash[current.road] = true && arr.push(current);
                        return arr
                    }, []);
                    for (var k in road711) {
                        selectroad.append('<option value="' + road711[k].road + '">' + road711[k].road + "</option>")
                    }
                    for (var i in list711) {
                        clientzipcode.append('<option value="' + list711[i].postcode + '">' + list711[i].postcode + "</option>")
                    }
                } else if (addr_type === "全家") {
                    listfamily = codeList.filter(function (item) {
                        return item.type + "" === "1"
                    });
                    if (listfamily.length === 0) {
                        listfamily = [{postcode: "此區域無店鋪,請選擇其他收貨方式", type: 1, road: "此區域無店鋪,請選擇其他收貨方式"}];
                        $("#zipcode_div").hide()
                    } else {
                        listfamily.unshift({postcode: "請選擇店鋪", type: 1, road: "請選擇街道"});
                        $("#zipcode_div").show()
                    }
                    var roadfamily = listfamily.reduce(function (arr, current) {
                        hash[current.road] ? "" : hash[current.road] = true && arr.push(current);
                        return arr
                    }, []);
                    for (var k in roadfamily) {
                        selectroad.append('<option value="' + roadfamily[k].road + '">' + roadfamily[k].road + "</option>")
                    }
                    for (var i in listfamily) {
                        clientzipcode.append('<option value="' + listfamily[i].postcode + '">' + listfamily[i].postcode + "</option>")
                    }
                }
            }
        } else {
            for (var i in codeList) {
                clientzipcode.append('<option value="' + codeList[i].postcode + '">' + codeList[i].postcode + "</option>")
            }
        }
        changeCode()
    } else if (ele === "#city") {
        cityList = address;
        for (var i in cityList) {
            eleJQ.append('<option value="' + cityList[i] + '" data-id="' + cityList[i] + '">' + cityList[i] + "</option>")
        }
    } else if (ele === "#area") {
        $("#area").empty();
        areaList = address;
        for (var i in areaList) {
            eleJQ.append('<option value="' + areaList[i].area + '" data-id="' + areaList[i].area + '">' + areaList[i].area + "</option>")
        }
    }
}

$("#clientzipcode").change(function () {
    changeCode()
});

function changeCode() {
    postage = 0;
    var postElement = $("#postage");
    var clientzipcode = $("#clientzipcode");
    var code = clientzipcode.children(":selected").val() ? clientzipcode.children(":selected").val() : clientzipcode.val();
    var freight = $("#freight");
    var freight_div = $("#freight_div");
    var realprice = $("#realprice");
    if (appData.money === "RM" || appData.money === "฿") {
        for (var i in codeList) {
            if (codeList[i].postcode === code) {
                if (codeList[i].frieight !== "" && codeList[i].frieight !== undefined && code !== " ") {
                    postElement.show();
                    postage = Number(codeList[i].frieight);
                    postElement.text("此地区需支付运费" + "     " + appData.money + " " + postage);
                    if (postage && appData.realprice) {
                        freight.text(appData.money + " " + postage);
                        freight_div.show();
                        realprice.text(appData.money + " " + (appData.realprice + postage))
                    }
                } else {
                    postElement.hide();
                    if (appData.realprice) {
                        freight_div.hide();
                        realprice.text(appData.money + " " + appData.realprice)
                    }
                }
            }
        }
    } else {
        var areaEle = $("#area");
        var area = areaEle.children(":selected").val() ? areaEle.children(":selected").val() : areaEle.val();
        for (var i in areaList) {
            if (areaList[i].area === area) {
                if (areaList[i].frieight !== "" && areaList[i].frieight !== undefined && area !== " ") {
                    postElement.show();
                    postage = Number(areaList[i].frieight);
                    postElement.text("此地区需支付运费" + "     " + appData.money + " " + postage);
                    if (postage && appData.realprice) {
                        freight.text(appData.money + " " + postage);
                        freight_div.show();
                        realprice.text(appData.money + " " + (appData.realprice + postage))
                    }
                } else {
                    postElement.hide();
                    if (appData.realprice) {
                        freight_div.hide();
                        realprice.text(appData.money + " " + appData.realprice)
                    }
                }
            }
        }
    }
}

$("#address_method .radio").click(function () {
    $(this).find("input").attr("checked", "checked");
    var city = $("#city").val();
    var area = $("#area").val();
    if ($("#address2").is(":checked")) {
        $("#clientaddress").val("711").attr("disabled", "disabled");
        $("#address_div").hide();
        $("#zipcode_div").show();
        $("#twroad").show()
    } else if ($("#address3").is(":checked")) {
        $("#clientaddress").val("全家").attr("disabled", "disabled");
        $("#address_div").hide();
        $("#zipcode_div").show();
        $("#twroad").show()
    } else if ($("#address1").is(":checked")) {
        $("#address_div").show();
        $("#clientaddress").val("").removeAttr("disabled");
        $("#zipcode_div").hide();
        $("#twroad").hide()
    }
    $(this).siblings().find("input").removeAttr("checked");
    if (area && area !== "區縣") {
        init_Select(appData.money, city, area, "")
    }
});
$("#selectroad").change(function () {
    var clientzipcode = $("#clientzipcode");
    clientzipcode.empty();
    var roadname = $("#selectroad").val();
    if ($("#address2").is(":checked")) {
        if (roadname && roadname !== "請選擇街道") {
            for (var i in list711) {
                if (list711[i].road === roadname) {
                    clientzipcode.append('<option value="' + list711[i].postcode + '">' + list711[i].postcode + "</option>")
                }
            }
        } else {
            for (var i in list711) {
                clientzipcode.append('<option value="' + list711[i].postcode + '">' + list711[i].postcode + "</option>")
            }
        }
    } else {
        if (roadname && roadname !== "請選擇街道") {
            for (var i in listfamily) {
                if (listfamily[i].road === roadname) {
                    clientzipcode.append('<option value="' + listfamily[i].postcode + '">' + listfamily[i].postcode + "</option>")
                }
            }
        } else {
            for (var i in listfamily) {
                clientzipcode.append('<option value="' + listfamily[i].postcode + '">' + listfamily[i].postcode + "</option>")
            }
        }
    }
});
$(".find-order").click(function () {
    var expressinfo = $("#expressinfo").val();
    var find_btn = $(".find-btn");
    if (!expressinfo) {
        $("#find_result").empty();
        return tools.show_msg(findStr)
    }
    find_btn.text("wait 10s");
    find_btn.attr("disabled", "true").addClass("disabled");
    var time = 9;
    var id = setInterval(function () {
        find_btn.text("wait " + time + "s");
        time--;
        if (time === -1) {
            find_btn.removeAttr("disabled").removeClass("disabled");
            find_btn.text(findbtnStr);
            clearInterval(id)
        }
    }, 1e3);
    $.post(appData.apiserver + "/single/queryorder/", {
        expressinfo: expressinfo,
        url: window.location.href
    }, function (data) {
        tools.close_all();
        if (data.Error) {
            tools.show_msg(data.Info[appData.language])
        } else {
            $("#find_result").html('<li  style="position: relative;border-bottom: none;" onclick="close_orderinfo()"> <span class="closeBtn" style="top:-2px;"></span></li>');
            if (data.orders && data.orders.length) {
                $.each(data.orders, function (key, order) {
                    if (order) {
                        var goodsinfo = order.goodsinfo;
                        var li = '<li class="am-padding-xs am-text-sm"><div>' + ordertimeStr + " ：<span>" + order.ordertime + "</span></div><div>" + orderidStr + " ：<span>" + order.orderid + '</span> <span class="am-fr am-text-danger">' + order.orderstate + "</span></div>" + "<div>" + ordernameStr + " ：<span>" + order.clientname + " (" + order.clientphone + ")</span></div><div>" + orderaddressStr + " ：<span>" + order.clientaddress + '</span></div><div class="am-padding-xs">';
                        for (var i in goodsinfo) {
                            var goods = goodsinfo[i];
                            if (!goods) continue;
                            li += "<div>" + goods.name + " " + goods.specname + " " + goods.option1 + " " + goods.option2 + " X " + goods.number + "</div>"
                        }
                        li += "</div></li>";
                        $("#find_result").append(li)
                    }
                })
            } else {
                $("#find_result").append("<li>" + orderError + "</li>")
            }
        }
    })
});

function close_orderinfo() {
    $("#find_result").empty();
    $("#expressinfo").val("");
    $(".find-btn").removeAttr("disabled").removeClass("disabled")
}

var show_kflist_timer;
var kf_isshow = false;
$("#kefu_btn").click(function () {
    show_kflist()
});

function show_kflist() {
    var kf_list = $(".kf_list");
    if (kf_isshow) {
        kf_list.hide();
        kf_isshow = false;
        clearTimeout(show_kflist_timer)
    } else {
        kf_list.show();
        kf_isshow = true;
        show_kflist_timer = setTimeout(function () {
            kf_list.hide()
        }, 1e3 * 8)
    }
}

$(".go-buy").click(function () {
    document.getElementById("buy").scrollIntoView(true)
});

function throttle(func, wait) {
    var lastTime = null;
    var timeout;
    return function () {
        var context = this;
        var now = new Date;
        if (now - lastTime - wait > 0) {
            if (timeout) {
                clearTimeout(timeout);
                timeout = null
            }
            func.apply(context, arguments);
            lastTime = now
        } else if (!timeout) {
            timeout = setTimeout(function () {
                func.apply(context, arguments)
            }, wait)
        }
    }
}

function check_top() {
    var spec_Btns = $("#buy");
    if (spec_Btns.offset()) {
        var ele_top = spec_Btns.offset().top;
        var top = (window.innerHeight ? window.innerHeight : $(window).height()) + $(window).scrollTop();
        if (top >= ele_top) {
            $(".cart-box-fixed").hide()
        } else {
            $(".cart-box-fixed").show()
        }
    }
}

if ($("#buy").length) {
    var throttleRun = throttle(check_top, 400);
    window.addEventListener("scroll", throttleRun)
}

function add_comment() {
    var comment_phone = $("#comment_phone");
    var comment_body = $("#comment_body");
    var comment_btn = $(".comment_btn");
    var a = comment_phone.val();
    var e = comment_body.val();
    var t = comment_btn.text();
    comment_btn.attr("disabled", "disabled");
    comment_btn.html(submitComment);
    setTimeout(function () {
        comment_btn.html(t);
        comment_btn.attr("disabled", !1)
    }, 200);
    $.post("/comments/add", {
        goodsid: appData.goods.id,
        phone: a,
        body: e,
        sitedir: appData.sitedir,
        referrer: document.referrer ? document.referrer : "直接进入"
    }, function (a) {
        tools.show_msg(a.Info[appData.language]);
        a.Error || comment_phone.val("");
        comment_body.val("");
        comment_btn.html(t);
        comment_btn.attr("disabled", !1)
    })
}

$(".show_specwin").click(function () {
    show_specwin()
});

function show_specwin() {
    tools.show_win("#specWin", "450px");
    hide_cartwin();
    hide_successwin()
}

function hide_specwin() {
    tools.close_win("#specWin")
}

function show_cartwin() {
    refresh_prod_ul();
    tools.show_win("#cartWin", "100%");
    hide_specwin();
    hide_successwin()
}

function hide_cartwin() {
    tools.close_win("#cartWin")
}

function show_successwin() {
    tools.show_win("#successWin", "100%");
    hide_specwin();
    hide_cartwin();
    hide_successbuy()
}

function hide_successwin() {
    tools.close_win("#successWin")
}

function hide_successbuy() {
    tools.show_win("#success");
    tools.close_win("#buy")
}

function show_cartisempty() {
    hide_cartwin();
    hide_specwin();
    $("#empty").show();
    $("#price").hide()
}

var submiting = false;
var card_orderid = "";

function submit_order_nocart(token) {
    if (submiting) return;
    if (appData.prods.length === 0) return;
    var cartinfo = [];
    for (var i in appData.prods) {
        if (i < $(".product_item").length) {
            var prod = appData.prods[i];
            if (!prod.id || !prod.sku || prod.price === 0) {
                tools.show_msg(selectStr + (parseInt(i) + 1));
                return
            }
            for (var j in appData.goods.specs) {
                var spec = appData.goods.specs[j];
                if (prod.sku === spec.id) {
                    if (spec.inventory === 0) {
                        tools.show_msg(selectOos + (parseInt(i) + 1) + selectOos1);
                        return
                    }
                }
            }
            cartinfo.push({id: prod.id, sku: prod.sku, img: prod.img, sitedir: appData.sitedir, number: prod.number})
        }
    }
    var map = {}, mergeCartinfo = [];
    for (var i = 0; i < cartinfo.length; i++) {
        var ai = cartinfo[i];
        if (!map[ai.sku]) {
            mergeCartinfo.push({id: ai.id, sku: ai.sku, img: ai.img, sitedir: ai.sitedir, number: ai.number});
            map[ai.sku] = ai
        } else {
            for (var j = 0; j < mergeCartinfo.length; j++) {
                var dj = mergeCartinfo[j];
                if (dj.sku === ai.sku) {
                    dj.number += ai.number;
                    break
                }
            }
        }
    }
    var giftCartinfo = {}, giftcount;
    for (var i in appData.goods.manyoff) {
        if (appData.goods.manyoff[i].salecount === appData.prods.length) {
            giftcount = appData.goods.manyoff[i].giftcount
        }
    }
    if (appData.giftGoodsIds && giftcount) {
        for (var i in appData.giftSelect) {
            var gifts = [];
            for (var k in appData.giftSelect[i]) {
                var prod = appData.giftSelect[i][k];
                if (!prod.id || !prod.sku) {
                    tools.show_msg(selectGiftStr + (parseInt(i) + 1));
                    return
                }
                gifts.push({id: prod.id, sku: prod.sku, img: prod.img, sitedir: appData.sitedir, number: prod.number})
            }
            var temp = {}, mergeGiftsinfo = [];
            for (var f = 0; f < gifts.length; f++) {
                var a = gifts[f];
                if (!temp[a.sku]) {
                    mergeGiftsinfo.push({id: a.id, sku: a.sku, img: a.img, sitedir: a.sitedir, number: a.number});
                    temp[a.sku] = a
                } else {
                    for (var j = 0; j < mergeGiftsinfo.length; j++) {
                        var d = mergeGiftsinfo[j];
                        if (d.sku === a.sku) {
                            d.number += a.number;
                            break
                        }
                    }
                }
            }
            giftCartinfo[i] = mergeGiftsinfo
        }
    }
    var name = /^\s*$/;
    var otherPhone = /^([0-9]+)$/;
    var clientinfo = {};
    clientinfo.clientname = $("#clientname").val();
    clientinfo.clientphone = $("#clientphone").val();
    clientinfo.clientaddress = $("#clientaddress").val();
    clientinfo.clientemail = $("#clientemail").val();
    clientinfo.clientzipcode = $("#clientzipcode").children(":selected").val() ? $("#clientzipcode").children(":selected").val() : $("#clientzipcode").val();
    clientinfo.city = $("#city").children(":selected").val();
    clientinfo.area = $("#area").children(":selected").val() ? $("#area").children(":selected").val() : $("#area").val();
    if (appData.money === "฿") {
        clientinfo.city = clientinfo.city ? clientinfo.city.split("/")[0] : clientinfo.city;
        clientinfo.area = clientinfo.area ? clientinfo.area.split("/")[0] : clientinfo.area
    }
    clientinfo.clientdispatchtime = $("#clientdispatchtime").children(":selected").val();
    clientinfo.clientotherinfo = $("#clientotherinfo").val();
    clientinfo.payment = $("input.radio:checked").val();
    clientinfo.store_delivery = $("#address_method input:checked").val();
    clientinfo.remoteMoney = postage ? postage : 0;
    if (clientinfo.store_delivery === "711" || clientinfo.store_delivery === "全家") {
        if (clientinfo.clientzipcode && clientinfo.clientzipcode !== "undefined") {
            if (clientinfo.clientzipcode === "請選擇店鋪") {
                $("#clientzipcode").focus();
                return tools.show_msg("請選擇店鋪")
            }
            if (clientinfo.clientzipcode === "此區域無店鋪,請選擇其他收貨方式") {
                $("#clientzipcode").focus();
                return tools.show_msg("此區域無店鋪,請選擇其他收貨方式")
            }
        } else {
            $("#clientzipcode").val("");
            $("#clientzipcode").focus();
            return tools.show_msg(addressStr)
        }
    }
    if (!clientinfo.clientname || name.test(clientinfo.clientname)) {
        $("#clientname").focus();
        return tools.show_msg(nameStr)
    }
    if (!clientinfo.clientphone || clientinfo.clientphone === " ") {
        $("#clientphone").focus();
        return tools.show_msg(PhoneStr)
    }
    if (appData.money !== "￥" && appData.money !== "S$") {
        if (clientinfo.city === "城市" || clientinfo.city === "Province" || clientinfo.city === "จังหวัด" || clientinfo.city === "区域" || clientinfo.city === undefined || clientinfo.city === "都道府県を選択") {
            $("#city").focus();
            return tools.show_msg(cityStr)
        }
        if (clientinfo.area === "区县" || clientinfo.area === "區縣" || clientinfo.area === "City" || clientinfo.area === "เมือง" || clientinfo.area === "區" || clientinfo.area === undefined) {
            $("#area").focus();
            return tools.show_msg(areaStr)
        }
    } else {
        clientinfo.city = "";
        clientinfo.area = ""
    }
    var ranges = ["\ud83c[\udf00-\udfff]", "\ud83d[\udc00-\ude4f]", "\ud83d[\ude80-\udeff]"];
    clientinfo.clientemail = clientinfo.clientemail.replace(new RegExp(ranges.join("|"), "g"), "");
    clientinfo.clientaddress = clientinfo.clientaddress.replace(new RegExp(ranges.join("|"), "g"), "");
    clientinfo.clientotherinfo = clientinfo.clientotherinfo.replace(new RegExp(ranges.join("|"), "g"), "");
    if (!clientinfo.clientaddress || clientinfo.clientaddress === " ") {
        $("#clientaddress").focus();
        return tools.show_msg(addressStr)
    }
    if (appData.money === "S$" || appData.money === "RM" || appData.money === "฿") {
        if (!clientinfo.clientzipcode || clientinfo.clientzipcode === " " || !otherPhone.test(clientinfo.clientzipcode)) {
            $("#clientzipcode").focus();
            return tools.show_msg(postcodeStr)
        }
        if (appData.money === "RM" && clientinfo.clientzipcode.length !== 5) {
            $("#clientzipcode").focus();
            return tools.show_msg(postcodeStr)
        }
    }
    clientinfo.payment = $("#payment_method input:checked").val();
    if (clientinfo.payment + "" === "2") {
        var stripe = Stripe(appData.stripe_pk);
        var elements = stripe.elements();
        var style = {
            base: {
                color: "#32325d",
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": {color: "#aab7c4"}
            }, invalid: {color: "#fa755a", iconColor: "#fa755a"}
        };
        var card = elements.create("card", {style: style});
        card.mount("#card-element");
        card.addEventListener("change", function (event) {
            var displayError = document.getElementById("card-errors");
            if (event.error) {
                displayError.textContent = event.error.message
            } else {
                displayError.textContent = ""
            }
        });
        $("#cardWin").show();
        var form = document.getElementById("payment-form");
        form.addEventListener("submit", function (event) {
            event.preventDefault();
            stripe.createToken(card).then(function (result) {
                if (result.error) {
                    var errorElement = document.getElementById("card-errors");
                    errorElement.textContent = result.error.message
                } else {
                    clientinfo.token = result.token.id;
                    handlerSubmit(clientinfo, mergeCartinfo, giftCartinfo)
                }
            })
        })
    } else {
        handlerSubmit(clientinfo, mergeCartinfo, giftCartinfo)
    }
}

function handlerSubmit(clientinfo, mergeCartinfo, giftCartinfo) {
    submiting = true;
    tools.show_loading(submitingStr, 30);
    var data = {
        goodsinfo: {id: appData.goods.id},
        cartinfo: mergeCartinfo,
        giftCartinfo: giftCartinfo,
        clientinfo: clientinfo,
        referrer: document.referrer ? document.referrer : "直接进入",
        siteurl: window.location.href
    };
    if (card_orderid) {
        data = {orderid: card_orderid, money: appData.money, orderprice: appData.realprice, clientinfo: {payment: 2}}
    }
    if (typeof fbq === "function") {
        var currency = "TWD";
        if (appData.money === "RM") currency = "MYR";
        if (appData.money === "HK") currency = "HKD"; else if (appData.money === "S$") currency = "SGD"; else if (appData.money === "฿") currency = "THB"; else if (appData.money === "円") currency = "JPN";
        fbq("track", "Purchase", {
            value: appData.realprice,
            currency: currency,
            content_name: appData.goods.name,
            contents: JSON.stringify(mergeCartinfo)
        })
    }
    $.ajax({
        type: "POST",
        url: appData.apiserver + "/single/createOrder",
        contentType: "application/json",
        data: JSON.stringify(data),
        error: function (data) {
            tools.close_all();
            submiting = false;
            tools.show_msg(submiterrorStr);
            $("#submit_btn").attr("disabled", false)
        },
        success: function (data) {
            tools.close_all();
            submiting = false;
            if (data.Error) {
                tools.show_msg(data.Info[appData.language])
            } else {
                if (clientinfo.payment + "" === "2") {
                    if (data.orderInfo.order_flag === 0) {
                        card_orderid = data.orderInfo.orderid;
                        return tools.show_msg(data.orderInfo.msg)
                    }
                }
                $("#clientname").val("");
                $("#clientphone").val("");
                $("#clientaddress").val("");
                $("#clientemail").val("");
                $("#clientzipcode").val("");
                $("#city").val("");
                $("#area").val("");
                $("#pianyuan>div").html("");
                $("#remote").attr("checked", false);
                $("#orderid").text(data.orderInfo.orderid);
                $("#order_clientname").text(data.orderInfo.clientname);
                $("#order_clientaddress").text(data.orderInfo.clientaddress);
                $("#order_clientphone").text(data.orderInfo.orderphone);
                $("#orderprice").text(appData.money + "" + data.orderInfo.orderprice);
                if (data.orderInfo.pay_receipt_url) {
                    $("#order_receipt").show();
                    $("#order_successaddress").append('<a target="_blank" href="' + data.orderInfo.pay_receipt_url + '">' + data.orderInfo.pay_receipt_url + "</a>")
                }
                var order_buygoods = $("#order_buygoods");
                for (var i in appData.prods) {
                    var prods = appData.prods[i];
                    order_buygoods.append('<li class="ordergoods_list" style="padding: 8px 0;border-bottom: 1px solid #ddd;margin: 0"><img class="ordergoods_img" style="width: 50px;height: 50px;vertical-align: middle;border: 1px solid #ccc;padding: 5px;margin-right: 10px;" src="' + appData.imgpath + prods.img + '-101"><span class="ordergoods_opt" style="display: inline-block;width: 40%;vertical-align: top;">' + prods.name + " " + prods.option1 + " " + prods.option2 + " " + appData.money + prods.price + " * " + '<span style="color: red;">' + prods.number + '</span></span><span class="ordergoods_subtotal" style="float: right;vertical-align: top;display: inline-block;">' + subtotal + ":" + appData.money + prods.price * prods.number + "</span></li>")
                }
                if (appData.giftSelect && appData.giftSelect.length > 0) {
                    for (var m in appData.giftSelect) {
                        if (appData.giftSelect[m].specname) {
                            var giftgoods = appData.giftSelect[m];
                            for (var n in giftgoods) {
                                var gifts = giftgoods[n];
                                order_buygoods.append('<li class="ordergoods_list" style="padding: 8px 0;border-bottom: 1px solid #ddd;margin: 0"><img class="ordergoods_img" style="width: 50px;height: 50px;vertical-align: middle;border: 1px solid #ccc;padding: 5px;margin-right: 10px;" src="' + appData.imgpath + gifts.img + '-101"><span class="ordergoods_opt" style="display: inline-block;width: 40%;vertical-align: top;">' + gifts.name + " " + gifts.option1 + " " + gifts.option2 + " " + appData.money + gifts.price + " * " + '<span style="color: red;">' + gifts.number + '</span></span><span class="ordergoods_subtotal" style="float: right;vertical-align: top;display: inline-block;"><del>' + subtotal + ":" + appData.money + prods.price * prods.number + '</del>  <span style="color: red">' + present + "</span></span></li>")
                            }
                        }
                    }
                }
                $("#cardWin").hide();
                if (clientinfo.payment + "" === "1") {
                    data.goods = appData.prods;
                    data.gifts = appData.giftSelect;
                    sessionStorage.setItem("orderData", JSON.stringify(data));
                    var orderPrice = data.orderInfo.orderprice;
                    var currency = "TWD";
                    if (appData.money === "RM") currency = "MYR"; else if (appData.money === "HK") currency = "HKD"; else if (appData.money === "S$") currency = "SGD"; else if (appData.money === "฿") currency = "THB";
                    var order_clientname = data.orderInfo.clientname;
                    var order_id = data.orderInfo.orderid;
                    var host = window.location.origin + "/api/shop/paypalPayment";
                    var returnurl = window.location.origin + "/" + appData.sitedir + "?paypal=success";
                    var cancelurl = window.location.origin + "/" + appData.sitedir + "?paypal=cancel";
                    var formhtml = ' <form action="https://www.paypal.com/cgi-bin/webscr" method="post" id="sform">' + '<input type="hidden" name="cmd" value="_xclick">' + '<input type="hidden" name="business" value=' + appData.clientId + ">" + '<input type="hidden" name="item_name"  value=' + appData.goods.name + ">" + '<input id="amount" type="hidden" name="amount" value=' + orderPrice + ">" + '<input type="hidden" name="currency_code" value=' + currency + ">" + '<input type="hidden" name="return" value=' + returnurl + ">" + '<input type="hidden" name="notify_url" value=' + host + ">" + '<input type="hidden" name="cancel_return" value=' + cancelurl + ">" + '<input id="invoice" type="hidden" name="invoice" value=' + order_id + ">" + '<input type="hidden" name="charset" value="utf-8">' + '<input type="hidden" name="no_shipping" value="1">' + '<input type="hidden" name="no_note" value=' + order_clientname + ">" + '<input type="hidden" name="bn" value="IC_Sample">' + '<button id="paypal" type="submit" style="border-radius: 5px;border: #ffc439;cursor: pointer;background-color: #ffc439;"><img style="width:70px;" src="https://shop.static.zxkf.cc/paypal.svg"></button>' + "</form>";
                    var paypalButton = $("#paypal-button");
                    paypalButton.append(formhtml);
                    paypalButton.show();
                    $("#continue").hide();
                    $("#payment").show();
                    $("#ordersuccess").hide();
                    $("#paypal").click()
                } else {
                    show_successwin()
                }
            }
        }
    })
}

$("#tijiao").off("click").on("click", function () {
    submit_order_nocart()
});

function submit_order() {
    if (submiting) return;
    if (cart.getAllProduct().length === 0) return;
    var cartinfo = [], gifts = [], giftCartinfo = {};
    var prods = cart.getAllProduct();
    for (var i in prods) {
        var prod = prods[i];
        cartinfo.push({id: prod.id, sku: prod.sku, img: prod.img, sitedir: appData.sitedir, number: prod.number});
        if (appData.giftGoodsIds) {
            for (var j in prod.giftgoods) {
                var gift = prod.giftgoods[j];
                gifts.push({id: gift.id, sku: gift.sku, img: gift.img, sitedir: appData.sitedir, number: gift.number})
            }
        }
    }
    if (gifts) {
        for (var i in appData.giftGoodsIds) {
            var giftsArr = [];
            for (var j in gifts) {
                if (gifts[j].id === appData.giftGoodsIds[i].id) {
                    giftsArr.push(gifts[j])
                }
            }
            var temp = {}, mergeGiftsinfo = [];
            for (var f = 0; f < giftsArr.length; f++) {
                var a = giftsArr[f];
                if (!temp[a.sku]) {
                    mergeGiftsinfo.push({id: a.id, sku: a.sku, img: a.img, sitedir: a.sitedir, number: a.number});
                    temp[a.sku] = a
                } else {
                    for (var j = 0; j < mergeGiftsinfo.length; j++) {
                        var d = mergeGiftsinfo[j];
                        if (d.sku === a.sku) {
                            d.number += a.number;
                            break
                        }
                    }
                }
            }
            giftCartinfo[i] = mergeGiftsinfo
        }
    }
    var name = /^\s*$/;
    var otherPhone = /^([0-9]+)$/;
    var clientinfo = {};
    clientinfo.clientname = $("#clientname").val();
    clientinfo.clientphone = $("#clientphone").val();
    clientinfo.clientaddress = $("#clientaddress").val();
    clientinfo.clientemail = $("#clientemail").val();
    clientinfo.clientzipcode = $("#clientzipcode").children(":selected").val() ? $("#clientzipcode").children(":selected").val() : $("#clientzipcode").val();
    clientinfo.city = $("#city").children(":selected").val();
    clientinfo.area = $("#area").children(":selected").val() ? $("#area").children(":selected").val() : $("#area").val();
    if (appData.money === "฿") {
        clientinfo.city = clientinfo.city ? clientinfo.city.split("/")[0] : clientinfo.city;
        clientinfo.area = clientinfo.area ? clientinfo.area.split("/")[0] : clientinfo.area
    }
    clientinfo.store_delivery = $("#address_method input:checked").val();
    if (clientinfo.store_delivery === "711" || clientinfo.store_delivery === "全家") {
        if (clientinfo.clientzipcode && clientinfo.clientzipcode !== "undefined") {
            if (clientinfo.clientzipcode === "請選擇店鋪") {
                $("#clientzipcode").focus();
                return tools.show_msg("請選擇店鋪")
            }
            if (clientinfo.clientzipcode === "此區域無店鋪,請選擇其他收貨方式") {
                $("#clientzipcode").focus();
                return tools.show_msg("此區域無店鋪,請選擇其他收貨方式")
            }
        } else {
            $("#clientzipcode").val("");
            $("#clientzipcode").focus();
            return tools.show_msg(addressStr)
        }
    }
    clientinfo.clientdispatchtime = $("#clientdispatchtime").children(":selected").val();
    clientinfo.clientotherinfo = $("#clientotherinfo").val();
    clientinfo.remoteMoney = postage ? postage : 0;
    if (!clientinfo.clientname || name.test(clientinfo.clientname)) {
        $("#clientname").focus();
        return tools.show_msg(nameStr)
    }
    if (!clientinfo.clientphone || clientinfo.clientphone === " ") {
        $("#clientphone").focus();
        return tools.show_msg(PhoneStr)
    }
    if (appData.money !== "￥" && appData.money !== "S$") {
        if (clientinfo.city === "城市" || clientinfo.city === "Province" || clientinfo.city === "จังหวัด" || clientinfo.city === "区域" || clientinfo.city === undefined || clientinfo.city === "都道府県を選択") {
            $("#city").focus();
            return tools.show_msg(cityStr)
        }
        if (clientinfo.area === "区县" || clientinfo.area === "區縣" || clientinfo.area === "City" || clientinfo.area === "เมือง" || clientinfo.area === "區" || clientinfo.area === undefined) {
            $("#area").focus();
            return tools.show_msg(areaStr)
        }
    } else {
        clientinfo.city = "";
        clientinfo.area = ""
    }
    var ranges = ["\ud83c[\udf00-\udfff]", "\ud83d[\udc00-\ude4f]", "\ud83d[\ude80-\udeff]"];
    clientinfo.clientemail = clientinfo.clientemail.replace(new RegExp(ranges.join("|"), "g"), "");
    clientinfo.clientaddress = clientinfo.clientaddress.replace(new RegExp(ranges.join("|"), "g"), "");
    clientinfo.clientotherinfo = clientinfo.clientotherinfo.replace(new RegExp(ranges.join("|"), "g"), "");
    if (!clientinfo.clientaddress || clientinfo.clientaddress === " ") {
        $("#clientaddress").focus();
        return tools.show_msg(addressStr)
    }
    if (appData.money === "S$" || appData.money === "RM" || appData.money === "฿") {
        if (!clientinfo.clientzipcode || clientinfo.clientzipcode === " " || !otherPhone.test(clientinfo.clientzipcode)) {
            $("#clientzipcode").focus();
            return tools.show_msg(postcodeStr)
        }
        if (appData.money === "RM" && clientinfo.clientzipcode.length !== 5) {
            $("#clientzipcode").focus();
            return tools.show_msg(postcodeStr)
        }
    }
    clientinfo.payment = 0;
    submiting = true;
    tools.show_loading(submitingStr, 30);
    if (typeof fbq === "function") {
        var currency = "TWD";
        if (appData.money === "RM") currency = "MYR";
        if (appData.money === "HK") currency = "HKD"; else if (appData.money === "S$") currency = "SGD"; else if (appData.money === "฿") currency = "THB"; else if (appData.money === "円") currency = "JPN";
        fbq("track", "Purchase", {
            value: appData.realprice,
            currency: currency,
            content_name: appData.goods.name,
            contents: cartinfo
        })
    }
    $.ajax({
        type: "POST",
        url: appData.apiserver + "/single/createOrder",
        contentType: "application/json",
        data: JSON.stringify({
            goodsinfo: {id: appData.goods.id},
            cartinfo: cartinfo,
            giftCartinfo: giftCartinfo,
            clientinfo: clientinfo,
            referrer: document.referrer ? document.referrer : "直接进入",
            siteurl: window.location.href
        }),
        error: function (data) {
            tools.close_all();
            submiting = false;
            tools.show_msg(submiterrorStr);
            $("#submit_btn").attr("disabled", false)
        },
        success: function (data) {
            tools.close_all();
            submiting = false;
            if (data.Error) {
                tools.show_msg(data.Info[appData.language])
            } else {
                $("#clientname").val("");
                $("#clientphone").val("");
                $("#clientaddress").val("");
                $("#clientemail").val("");
                $("#clientzipcode").val("");
                $("#city").val("");
                $("#area").val("");
                $("#orderid").text(data.orderInfo.orderid);
                $("#order_clientname").text(data.orderInfo.clientname);
                $("#order_clientaddress").text(data.orderInfo.clientaddress);
                $("#order_clientphone").text(data.orderInfo.orderphone);
                $("#orderprice").text(appData.money + "" + data.orderInfo.orderprice);
                var order_buygoods = $("#order_buygoods");
                for (var i in cart.getAllProduct()) {
                    var prods = cart.getAllProduct()[i];
                    order_buygoods.append('<li class="ordergoods_list" style="padding: 8px 0;border-bottom: 1px solid #ddd;margin: 0"><img class="ordergoods_img" style="width: 50px;height: 50px;vertical-align: middle;border: 1px solid #ccc;padding: 5px;margin-right: 10px;" src="' + appData.imgpath + prods.img + '-101"><span class="ordergoods_opt" style="display: inline-block;width: 40%;vertical-align: top;">' + prods.name + " " + prods.option1 + " " + prods.option2 + " " + appData.money + prods.price + " * " + '<span style="color: red;">' + prods.number + '</span></span><span class="ordergoods_subtotal" style="float: right;vertical-align: top;display: inline-block;">' + subtotal + ":" + appData.money + prods.price * prods.number + "</span></li>");
                    if (prods.giftgoods && prods.giftgoods.length > 0) {
                        for (var j in prods.giftgoods) {
                            var gifts = prods.giftgoods[j];
                            order_buygoods.append('<li class="ordergoods_list" style="padding: 8px 0;border-bottom: 1px solid #ddd;margin: 0"><img class="ordergoods_img" style="width: 50px;height: 50px;vertical-align: middle;border: 1px solid #ccc;padding: 5px;margin-right: 10px;" src="' + appData.imgpath + gifts.img + '-101"><span style="display: inline-block;width: 40%;vertical-align: top;" class="ordergoods_opt">' + gifts.name + " " + gifts.option1 + " " + gifts.option2 + " " + appData.money + gifts.price + " * " + '<span style="color: red;">' + gifts.number + '</span></span><span class="ordergoods_subtotal" style="float: right;vertical-align: top;display: inline-block;"><del>' + subtotal + ":" + appData.money + prods.price * prods.number + '</del>  <span style="color: red">' + present + "</span></span></li>")
                        }
                    }
                }
                show_successwin();
                clear_cart();
                cart.showTotalNum()
            }
        }
    })
}

if (window.location.href.indexOf("buy") === -1 && window.location.href.indexOf("searchorder") === -1 && window.localStorage) {
    window.localStorage.setItem("url", window.location.href)
}
$(".opt1_cart").click(function () {
    select_specitem(this)
});

function select_specitem(ele) {
    var specEle = $(ele);
    if (appData.selectProd.name === specEle.data("name")) return;
    appData.selectProd.name = specEle.data("name");
    specEle.siblings(".opt1").removeClass("active");
    specEle.addClass("active");
    var items = $("#product-spec .option1>.opt2");
    if (items.length > 0) {
        items.removeClass("active");
        items.addClass("disable");
        for (var i = 0; i < items.length; i++) {
            items.eq(i).text(items.eq(i).data("name"));
            items.eq(i).removeClass("oos")
        }
        for (var i in appData.goods.specs) {
            var spec = appData.goods.specs[i];
            if (spec.name + "" === appData.selectProd.name + "") {
                $.each(items, function (index, span) {
                    if ($(span).data("name") + "" === spec.option1 + "") {
                        var item = $(items[index]);
                        item.data("sku", spec.id);
                        item.data("price", spec.price);
                        item.removeClass("disable");
                        if ($("#spec_option2>.opt3").length === 0) {
                            if (spec.inventory === 0) {
                                item.addClass("disable").addClass("oos");
                                item.text(item.data("name") + oos)
                            } else {
                                item.removeClass("disable").removeClass("oos");
                                item.text(item.data("name"))
                            }
                        }
                    }
                })
            }
        }
        var option1_li = $(items.not(".disable"));
        if (option1_li.length === 0) {
            appData.selectProd.sku = specEle.data("sku");
            appData.selectProd.price = specEle.data("price");
            $("#goods_price").text(appData.money + " " + appData.selectProd.price)
        } else if (option1_li.length === 1) {
            appData.selectProd.sku = "";
            appData.selectProd.option1 = "";
            appData.selectProd.img = specEle.data("img");
            $("#spec-goods").text(appData.selectProd.name + " " + appData.selectProd.option1 + " " + appData.selectProd.option2);
            if (specEle.data("img")) {
                $("#selected-img").attr("src", appData.imgpath + specEle.data("img"))
            }
            option1_li.click();
            return false
        } else {
            appData.selectProd.sku = "";
            appData.selectProd.option1 = ""
        }
        var option2_li = $("#product-spec .option2>.opt3");
        option2_li.removeClass("active");
        option2_li.addClass("disable");
        for (var i = 0; i < option2_li.length; i++) {
            option2_li.eq(i).text(option2_li.eq(i).data("name"));
            option2_li.eq(i).removeClass("oos")
        }
    } else {
        appData.selectProd.sku = specEle.data("sku");
        appData.selectProd.price = specEle.data("price");
        $("#goods_price").text(appData.money + " " + appData.selectProd.price)
    }
    appData.selectProd.img = specEle.data("img");
    $("#spec-goods").text(appData.selectProd.name + " " + appData.selectProd.option1 + " " + appData.selectProd.option2);
    if (specEle.data("img")) {
        $("#selected-img").attr("src", appData.imgpath + specEle.data("img"))
    }
}

$(".opt2_cart").click(function () {
    select_option1(this)
});

function select_option1(ele) {
    var optionEle = $(ele);
    if ($(".option1>.active").text() === optionEle.data("name")) return;
    if (optionEle.hasClass("disable")) return;
    optionEle.siblings(".opt2").removeClass("active");
    optionEle.addClass("active");
    appData.selectProd.option1 = optionEle.data("name");
    appData.selectProd.sku = optionEle.data("sku");
    var items = $("#product-spec .option2>.opt3");
    if (items.length > 0) {
        items.removeClass("active");
        items.addClass("disable");
        for (var i = 0; i < items.length; i++) {
            items.eq(i).text(items.eq(i).data("name"));
            items.eq(i).removeClass("oos")
        }
        for (var i in appData.goods.specs) {
            var spec = appData.goods.specs[i];
            if (spec.name + "" === appData.selectProd.name + "" && spec.option1 + "" === appData.selectProd.option1 + "") {
                $.each(items, function (index, span) {
                    if ($(span).data("name") + "" === spec.option2 + "") {
                        var item = $(items[index]);
                        item.data("price", spec.price);
                        item.data("sku", spec.id);
                        item.removeClass("disable");
                        if (spec.inventory === 0) {
                            item.addClass("disable").addClass("oos");
                            item.text(item.data("name") + oos)
                        } else {
                            item.removeClass("disable").removeClass("oos");
                            item.text(item.data("name"))
                        }
                    }
                })
            }
        }
        var option2_li = $(items.not(".disable"));
        if (option2_li.length === 0) {
            appData.selectProd.price = optionEle.data("price");
            appData.selectProd.sku = optionEle.data("sku");
            $("#goods_price").text(appData.money + appData.selectProd.price)
        } else if (option2_li.length === 1) {
            appData.selectProd.sku = "";
            appData.selectProd.option2 = "";
            $("#spec-goods").text(appData.selectProd.name + " " + appData.selectProd.option1 + " " + appData.selectProd.option2);
            option2_li.click();
            return false
        } else {
            appData.selectProd.sku = "";
            appData.selectProd.option2 = "";
            $("#spec-goods").text(appData.selectProd.name + " " + appData.selectProd.option1 + " " + appData.selectProd.option2)
        }
    } else {
        $.each(appData.goods.specs, function (index, spec) {
            if (spec.name + "" === "" + appData.selectProd.name && spec.option1 + "" === "" + appData.selectProd.option1) {
                appData.selectProd.price = spec.price;
                return false
            }
        });
        $("#spec-goods").text(appData.selectProd.name + " " + appData.selectProd.option1 + " " + appData.selectProd.option2);
        $("#goods_price").text(appData.money + appData.selectProd.price)
    }
}

$(".opt3_cart").click(function () {
    select_option2(this)
});

function select_option2(ele) {
    var optionEle = $(ele);
    if ($(".option2>.active").text() === optionEle.data("name")) return;
    if (optionEle.hasClass("disable")) return;
    optionEle.siblings(".opt3").removeClass("active");
    optionEle.addClass("active");
    appData.selectProd.option2 = optionEle.data("name");
    appData.selectProd.sku = optionEle.data("sku");
    $.each(appData.goods.specs, function (index, spec) {
        if (spec.name + "" === appData.selectProd.name + "" && spec.option1 + "" === appData.selectProd.option1 + "" && spec.option2 + "" === appData.selectProd.option2 + "") {
            appData.selectProd.price = spec.price;
            return false
        }
    });
    $("#spec-goods").text(appData.selectProd.name + " " + appData.selectProd.option1 + " " + appData.selectProd.option2);
    $("#goods_price").text(appData.money + appData.selectProd.price)
}

function calc_price() {
    var ret = cart.getQuantity();
    appData.prods = cart.getAllProduct();
    var allnum = ret.totalNumber;
    var allprice = 0;
    var manyoff_price = 0;
    var realprice = 0;
    var saleoff_price = 0;
    var moneyprice = 0;
    for (var i in appData.prods) {
        var prod = appData.prods[i];
        allprice += prod.price * prod.number
    }
    for (var j in appData.goods.manyoff_new) {
        var item = appData.goods.manyoff_new[j];
        for (var k = 1; k <= allnum; k++) {
            if (item.salecount === parseInt(k) && prod.price > 0) {
                manyoff_price += item.price
            }
        }
    }
    realprice = allprice - manyoff_price;
    for (var i in appData.goods.manyoff) {
        if (appData.goods.manyoff[i].salecount === ret.totalNumber) {
            if (appData.goods.manyoff[i].price > 0) {
                realprice = appData.goods.manyoff[i].price
            }
        }
    }
    for (var j in appData.goods.saleoff) {
        var item = appData.goods.saleoff[j];
        if (ret.totalNumber >= item.salecount) {
            saleoff_price = item.offprice
        }
    }
    realprice = realprice - saleoff_price;
    if (appData.goods.priceoff.length > 0) {
        appData.goods.priceoff = appData.goods.priceoff.sort(compare("totalmoney"));
        var i = com_index(appData.goods.priceoff, realprice);
        if (i >= 0) {
            moneyprice = appData.goods.priceoff[i].saleprice
        } else if (i === undefined) {
            moneyprice = appData.goods.priceoff[appData.goods.priceoff.length - 1].saleprice
        }
        realprice = realprice - moneyprice
    }
    if (manyoff_price > 0) {
        $("#many_discount").show();
        $("#manyoff").text(appData.money + " -" + manyoff_price)
    } else {
        $("#many_discount").hide()
    }
    if (saleoff_price > 0) $("#saleoffprice_div").show(); else $("#saleoffprice_div").hide();
    if (moneyprice > 0) {
        $("#moneyprice").show();
        $("#price_money").text(appData.money + "-" + moneyprice)
    } else {
        $("#moneyprice").hide()
    }
    $("#allCount").text(allnum);
    $("#allprice").text(appData.money + " " + allprice);
    $("#saleoffprice").text(appData.money + " - " + saleoff_price);
    if (postage === 0) {
        $("#freight_div").hide();
        $("#realprice").text(appData.money + " " + realprice)
    } else {
        $("#freight_div").show();
        $("#freight").text(appData.money + " " + postage);
        $("#realprice").text(appData.money + " " + (realprice + postage))
    }
    appData.realprice = realprice
}

$(".opt1_btn").click(function () {
    select_specitem_nocart(this, 1)
});

function select_specitem_nocart(ele, index) {
    var specEle = $(ele);
    if (appData.prods[index - 1].specname === specEle.data("name")) return;
    appData.prods[index - 1].specname = specEle.data("name");
    appData.prods[index - 1].img = specEle.data("img");
    specEle.siblings(".opt1").removeClass("active");
    specEle.addClass("active");
    var items = $("#spec_option1_" + index + ">.opt2");
    if (items.length > 0) {
        items.removeClass("active");
        items.addClass("disable");
        for (var i = 0; i < items.length; i++) {
            items.eq(i).text(items.eq(i).data("name"));
            items.eq(i).removeClass("oos")
        }
        for (var i in appData.goods.specs) {
            var spec = appData.goods.specs[i];
            if (spec.name + "" === appData.prods[index - 1].specname + "") {
                $.each(items, function (J, span) {
                    if ($(span).data("name") + "" === spec.option1 + "") {
                        var item = $(items[J]);
                        item.data("price", spec.price);
                        item.data("sku", spec.id);
                        item.removeClass("disable");
                        if ($("#spec_option2_" + index + ">.opt3").length === 0) {
                            if (spec.inventory === 0) {
                                item.addClass("disable").addClass("oos");
                                item.text(item.data("name") + oos)
                            } else {
                                item.removeClass("disable").removeClass("oos");
                                item.text(item.data("name"))
                            }
                        }
                    }
                })
            }
        }
        var option1_li = $(items.not(".disable"));
        if (option1_li.length === 0) {
            appData.prods[index - 1].sku = specEle.data("sku");
            appData.prods[index - 1].price = specEle.data("price");
            calc_price_nocart()
        } else if (option1_li.length === 1) {
            appData.prods[index - 1].sku = "";
            appData.prods[index - 1].option1 = "";
            option1_li.click();
            return false
        } else {
            appData.prods[index - 1].sku = "";
            appData.prods[index - 1].option1 = ""
        }
        var option2_li = $("#spec_option2_" + index + ">.opt3");
        option2_li.removeClass("active");
        option2_li.addClass("disable");
        for (var i = 0; i < option2_li.length; i++) {
            option2_li.eq(i).text(option2_li.eq(i).data("name"));
            option2_li.eq(i).removeClass("oos")
        }
    } else {
        appData.prods[index - 1].sku = specEle.data("sku");
        appData.prods[index - 1].price = specEle.data("price");
        calc_price_nocart()
    }
    appData.selectProd.img = specEle.data("img")
}

$(".opt2_btn").click(function () {
    select_option1_nocart(this, 1)
});

function select_option1_nocart(ele, index) {
    var optionEle = $(ele);
    if (appData.prods[index - 1].option1 === optionEle.data("name")) return;
    if (optionEle.hasClass("disable")) return;
    optionEle.siblings(".opt2").removeClass("active");
    optionEle.addClass("active");
    appData.prods[index - 1].option1 = optionEle.data("name");
    appData.prods[index - 1].sku = optionEle.data("sku");
    var items = $("#spec_option2_" + index + ">.opt3");
    if (items.length > 0) {
        for (var i = 0; i < items.length; i++) {
            items.eq(i).text(items.eq(i).data("name"));
            items.eq(i).removeClass("oos")
        }
        items.removeClass("active");
        items.addClass("disable");
        for (var i in appData.goods.specs) {
            var spec = appData.goods.specs[i];
            if (spec.name + "" === appData.prods[index - 1].specname + "" && spec.option1 + "" === appData.prods[index - 1].option1 + "") {
                $.each(items, function (J, span) {
                    if ($(span).data("name") + "" === spec.option2 + "") {
                        var item = $(items[J]);
                        item.data("price", spec.price);
                        item.data("sku", spec.id);
                        item.removeClass("disable");
                        if (spec.inventory === 0) {
                            item.addClass("disable").addClass("oos");
                            item.text(item.data("name") + oos)
                        } else {
                            item.removeClass("disable").removeClass("oos");
                            item.text(item.data("name"))
                        }
                    }
                })
            }
        }
        var option2_li = $(items.not(".disable"));
        if (option2_li.length === 0) {
            appData.prods[index - 1].price = optionEle.data("price");
            appData.prods[index - 1].sku = optionEle.data("sku");
            calc_price_nocart()
        } else if (option2_li.length === 1) {
            appData.prods[index - 1].sku = "";
            appData.prods[index - 1].option2 = "";
            option2_li.click();
            return false
        } else {
            appData.prods[index - 1].sku = "";
            appData.prods[index - 1].option2 = ""
        }
    } else {
        $.each(appData.goods.specs, function (i, spec) {
            if (spec.name + "" === "" + appData.prods[index - 1].specname && spec.option1 + "" === "" + appData.prods[index - 1].option1) {
                appData.prods[index - 1].price = spec.price;
                calc_price_nocart();
                return false
            }
        })
    }
}

$(".opt3_btn").click(function () {
    select_option2_nocart(this, 1)
});

function select_option2_nocart(ele, index) {
    var optionEle = $(ele);
    if (appData.prods[index - 1].option2 === optionEle.data("name")) return;
    if (optionEle.hasClass("disable")) return;
    optionEle.siblings(".opt3").removeClass("active");
    optionEle.addClass("active");
    appData.prods[index - 1].option2 = optionEle.data("name");
    appData.prods[index - 1].sku = optionEle.data("sku");
    $.each(appData.goods.specs, function (i, spec) {
        if (spec.name + "" === appData.prods[index - 1].specname + "" && spec.option1 + "" === appData.prods[index - 1].option1 + "" && spec.option2 + "" === appData.prods[index - 1].option2 + "") {
            appData.prods[index - 1].price = spec.price;
            calc_price_nocart();
            return false
        }
    })
}

function calc_price_nocart() {
    var allprice = 0;
    var manyoff_price = 0;
    var offprice = 0;
    var moneyprice = 0;
    var realprice = 0;
    for (var i in appData.prods) {
        var prod = appData.prods[i];
        allprice += prod.price;
        for (var j in appData.goods.manyoff_new) {
            var item = appData.goods.manyoff_new[j];
            if (item.salecount === parseInt(i) + 1 && prod.price > 0) {
                manyoff_price += item.price
            }
        }
    }
    realprice = allprice - manyoff_price;
    for (var i in appData.goods.manyoff) {
        if (appData.goods.manyoff[i].salecount === appData.prods.length) {
            if (appData.goods.manyoff[i].price > 0) {
                realprice = appData.goods.manyoff[i].price
            }
        }
    }
    if (appData.goods.saleoff.length > 0) {
        for (var i in appData.goods.saleoff) {
            var r = appData.goods.saleoff[i];
            if (appData.prods.length >= r.salecount) {
                offprice = r.offprice
            }
        }
    }
    realprice = realprice - offprice;
    if (appData.goods.priceoff && appData.goods.priceoff.length > 0) {
        appData.goods.priceoff = appData.goods.priceoff.sort(compare("totalmoney"));
        var i = com_index(appData.goods.priceoff, realprice);
        if (i >= 0) {
            moneyprice = appData.goods.priceoff[i].saleprice
        } else if (i === undefined) {
            moneyprice = appData.goods.priceoff[appData.goods.priceoff.length - 1].saleprice
        }
        realprice = realprice - moneyprice
    }
    $("#allprice").text(appData.money + " " + allprice);
    $("#allprice1").text(appData.money + " " + allprice);
    if (manyoff_price > 0) {
        $("#many_discount").show();
        $("#manyoff").text(appData.money + " -" + manyoff_price)
    } else {
        $("#many_discount").hide()
    }
    if (offprice > 0) {
        $("#price_off").show();
        $("#offprice").text(appData.money + "-" + offprice)
    } else {
        $("#price_off").hide()
    }
    if (moneyprice > 0) {
        $("#moneyprice").show();
        $("#price_money").text(appData.money + "-" + moneyprice)
    } else {
        $("#moneyprice").hide()
    }
    if (appData.goods.manyoff.length && allprice - realprice > 0) {
        $("#discount_money").show();
        $("#discount").text(appData.money + " " + (allprice - realprice))
    } else {
        $("#discount_money").hide()
    }
    if (postage === 0) {
        $("#freight_div").hide();
        $("#realprice").text(appData.money + " " + realprice)
    } else {
        $("#freight").text(appData.money + " " + postage);
        $("#freight_div").show();
        $("#realprice").text(appData.money + " " + (realprice + postage))
    }
    $("#realprice1").text(appData.money + " " + realprice);
    appData.realprice = realprice
}

function compare(property) {
    return function (a, b) {
        var value1 = a[property];
        var value2 = b[property];
        return value1 - value2
    }
}

function com_index(arr, num) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i].totalmoney > num) {
            return i - 1
        }
    }
}

function calc_salecount() {
    for (var i = 0; i < parseInt(appData.goods.manyoff_new[0].salecount); i++) {
        if (i === 0) {
            add_goodsinfo()
        } else {
            add_goodsinfo();
            add_spec(true)
        }
    }
}

var product_element = $("div.product_item");
var html = product_element ? product_element.html() : "";

function add_goodsinfo() {
    appData.prods.push({
        id: appData.goods.id,
        sourceid: appData.goods.sourceid,
        userkey: appData.goods.userkey,
        name: appData.goods.name,
        specname: "",
        sku: "",
        price: 0,
        img: "",
        option1: "",
        option2: "",
        number: 1
    })
}

function add_spec(hideclose) {
    if (hideclose) {
        $("#product-spec").append(" <div class='item product_item'>" + html + "</div>")
    } else {
        $("#product-spec").append(" <div class='item product_item'><div class='close rt' onclick='close_spec(this);close_giftspec();'><img src='http://static.seezt.cc/theme/jd/images/icon/15.png'></div>" + html + "</div>")
    }
    update_class()
}

function close_spec(ele) {
    var ele = $(ele);
    ele.parent("div.product_item").prop("outerHTML", "");
    appData.prods.splice(appData.prods.length - 1, 1);
    update_class();
    calc_price_nocart()
}

function update_class() {
    var product_item = $(".product_item");
    var length = parseInt(product_item.length);
    appData.index = length;
    product_item.eq(length - 1).find(".spec_Title span").text(appData.index);
    product_item.eq(length - 1).find(".user-name").attr("id", "spec_names_" + appData.index);
    product_item.eq(length - 1).find(".option1").attr("id", "spec_option1_" + appData.index);
    product_item.eq(length - 1).find(".option2").attr("id", "spec_option2_" + appData.index);
    product_item.eq(length - 1).find(".user-name>.opt1").attr("onclick", "select_specitem_nocart(this," + appData.index + ")");
    product_item.eq(length - 1).find(".option1>.opt2").attr("onclick", "select_option1_nocart(this," + appData.index + ")");
    product_item.eq(length - 1).find(".option2>.opt3").attr("onclick", "select_option2_nocart(this," + appData.index + ")");
    if (appData.goods.count_info && appData.goods.count_info.length > 1) {
        for (var i in appData.goods.count_info) {
            var count_info = appData.goods.count_info[i];
            if (parseInt(count_info.count) === appData.index) {
                product_item.eq(length - 1).find(".spec_Title i").text(appData.goods.count_info[i].name)
            }
        }
    }
}

$("#add_one").click(function () {
    add_one()
});

function add_one() {
    add_spec();
    add_goodsinfo();
    var product_item = $(".product_item");
    var length = parseInt(product_item.length);
    var isdefault = 0;
    for (var i in appData.goods.specs) {
        var spec = appData.goods.specs[i];
        var sku = spec.id;
        var items = product_item.eq(length - 1).find(".opt1");
        if ($("#spec_option1_1").length === 0) {
            if (spec.inventory === 0) {
                $.each(items, function (index, span) {
                    if ($(span).data("id") === sku) {
                        $(this).addClass("disable").addClass("oos");
                        $(this).children("span").css("color", "red").text($(span).data("name") + oos);
                        $(this).removeAttr("onclick")
                    }
                })
            }
        }
        if (spec.isdefault) {
            isdefault = spec.isdefault;
            $.each(items, function (index, span) {
                if ($(span).data("id") === sku) {
                    $(this).click();
                    return false
                }
            })
        }
    }
    enterIndex()
}

function init_nocart_oos() {
    for (var i in appData.goods.specs) {
        var spec = appData.goods.specs[i];
        if ($("#spec_option1_1").length === 0) {
            if (spec.inventory === 0) {
                var sku = spec.id;
                var items = $(".opt1");
                $.each(items, function (index, span) {
                    if ($(span).data("id") === sku) {
                        $(this).addClass("disable").addClass("oos");
                        $(this).children("span").css("color", "red").text($(span).data("name") + oos);
                        $(this).removeAttr("onclick")
                    }
                })
            }
        }
    }
}

function init_oos() {
    for (var i in appData.goods.specs) {
        var spec = appData.goods.specs[i];
        if ($("#spec_option1").length === 0) {
            if (spec.inventory === 0) {
                var sku = spec.id;
                var items = $(".opt1");
                $.each(items, function (index, span) {
                    if ($(span).data("id") === sku) {
                        $(this).addClass("disable").addClass("oos");
                        $(this).children("span").css("color", "red").text($(span).data("name") + oos);
                        $(this).removeAttr("onclick")
                    }
                })
            }
        }
    }
}

if ($("#spec_names_1").length) {
    init_nocart_oos()
} else {
    init_oos()
}
if (appData.goods.manyoff_new.length) {
    calc_salecount()
} else {
    add_goodsinfo()
}
appData.giftSelect = [];
if (appData.giftGoodsIds) {
    for (var i = 0; i < appData.giftGoodsIds.length; i++) {
        var gift = [{
            id: appData.giftGoodsIds[i].id,
            specname: "",
            sku: "",
            price: 0,
            img: "",
            option1: "",
            option2: "",
            number: 1,
            name: appData.giftGoodsIds[i].name
        }];
        appData.giftSelect[i] = gift
    }
}
var gifts_item = $(".gifts_item");
if (appData.giftGoodsIds) {
    for (var i in appData.giftGoodsIds) {
        gifts_item.eq(i).find(".user-name>.opt1").attr("onclick", "select_giftspec(this," + i + ",1)");
        gifts_item.eq(i).find(".option1>.opt2").attr("onclick", "select_giftoption1(this," + i + ",1)");
        gifts_item.eq(i).find(".option2>.opt3").attr("onclick", "select_giftoption2(this," + i + ",1)")
    }
    defaultSelected()
}
var gifthtml1 = $("#gifts").html();
if ($(".product_item").length) {
    enterIndex()
}

function enterIndex() {
    var goodslengthOne = $(".product_item").length;
    for (var i = 0; i < appData.goods.manyoff.length; i++) {
        if (appData.goods.manyoff[i].salecount === goodslengthOne) {
            if (appData.goods.manyoff[i].giftcount > 0 && appData.goods.manyoff[i].giftcount && appData.giftSelect.length) {
                $("#giftArea").show();
                $("#gifts").show();
                var temp = appData.goods.manyoff[i].giftcount - appData.giftSelect[0].length;
                if (temp > 0) {
                    for (var j = 0; j < temp; j++) {
                        $("#gifts").append(gifthtml1);
                        updateGift_class()
                    }
                } else {
                    var j = Math.abs(temp);
                    var a = $("div.gifts");
                    a.splice(a.length - j, j);
                    $("#gifts").html(a)
                }
                for (var k in appData.giftSelect) {
                    if (appData.giftSelect[k].length < appData.goods.manyoff[i].giftcount) {
                        appData.giftSelect[k].push({
                            id: appData.giftSelect[k][0].id,
                            specname: "",
                            sku: "",
                            price: 0,
                            img: "",
                            option1: "",
                            option2: "",
                            number: 1
                        })
                    } else if (appData.giftSelect[k].length > appData.goods.manyoff[i].giftcount) {
                        appData.giftSelect[k].splice(appData.giftSelect[k].length - 1, appData.giftSelect[k].length - appData.goods.manyoff[i].giftcount)
                    } else {
                        appData.giftSelect[k] = appData.giftSelect[k]
                    }
                }
                defaultSelected();
                break
            } else {
                $("#gifts").hide();
                $("#giftArea").hide()
            }
        } else {
            $("#gifts").hide();
            $("#giftArea").hide()
        }
    }
}

function close_giftspec() {
    enterIndex()
}

function updateGift_class() {
    var product_item = $(".gifts");
    var length = parseInt(product_item.length);
    appData.index = length;
    product_item.eq(length - 1).find(".spec_Title span").text(appData.index);
    for (var i in appData.giftGoodsIds) {
        product_item.eq(length - 1).children().eq(i).find(".user-name").attr("id", "gift_names_" + i + "_" + appData.index);
        product_item.eq(length - 1).children().eq(i).find(".option1").attr("id", "gift_option1_" + i + "_" + appData.index);
        product_item.eq(length - 1).children().eq(i).find(".option2").attr("id", "gift_option2_" + i + "_" + appData.index);
        product_item.eq(length - 1).children().eq(i).find(".user-name>.opt1").attr("onclick", "select_giftspec(this," + i + "," + appData.index + ")");
        product_item.eq(length - 1).children().eq(i).find(".option1>.opt2").attr("onclick", "select_giftoption1(this," + i + "," + appData.index + ")");
        product_item.eq(length - 1).children().eq(i).find(".option2>.opt3").attr("onclick", "select_giftoption2(this," + i + "," + appData.index + ")")
    }
}

function select_giftspec(ele, giftindex, index) {
    var specEle = $(ele);
    if (appData.giftSelect[giftindex][index - 1].specname === specEle.data("name")) return;
    appData.giftSelect[giftindex][index - 1].specname = specEle.data("name");
    appData.giftSelect[giftindex][index - 1].img = specEle.data("img");
    specEle.siblings(".opt1").removeClass("active");
    specEle.addClass("active");
    var items = $("#gift_option1_" + giftindex + "_" + index + ">.opt2");
    if (items.length > 0) {
        items.removeClass("active");
        items.addClass("disable");
        for (var i in appData.gifts[giftindex]) {
            var spec = appData.gifts[giftindex][i];
            if (spec.name + "" === appData.giftSelect[giftindex][index - 1].specname + "") {
                $.each(items, function (J, span) {
                    if ($(span).data("name") + "" === spec.option1 + "") {
                        var item = $(items[J]);
                        item.data("price", spec.price);
                        item.data("sku", spec.id);
                        item.removeClass("disable")
                    }
                })
            }
        }
        var option1_li = $(items.not(".disable"));
        if (option1_li.length === 0) {
            appData.giftSelect[giftindex][index - 1].sku = specEle.data("sku");
            appData.giftSelect[giftindex][index - 1].price = specEle.data("price")
        } else if (option1_li.length === 1) {
            appData.giftSelect[giftindex][index - 1].sku = "";
            appData.giftSelect[giftindex][index - 1].option1 = "";
            option1_li.click();
            return false
        } else {
            appData.giftSelect[giftindex][index - 1].sku = "";
            appData.giftSelect[giftindex][index - 1].option1 = ""
        }
        var option2_li = $("#gift_option2_" + giftindex + "_" + index + ">.opt3");
        option2_li.removeClass("active");
        option2_li.addClass("disable")
    } else {
        appData.giftSelect[giftindex][index - 1].sku = specEle.data("sku");
        appData.giftSelect[giftindex][index - 1].price = specEle.data("price")
    }
}

function select_giftoption1(ele, giftindex, index) {
    var optionEle = $(ele);
    if (appData.giftSelect[giftindex][index - 1].option1 === optionEle.data("name")) return;
    if (optionEle.hasClass("disable")) return;
    optionEle.siblings(".opt2").removeClass("active");
    optionEle.addClass("active");
    appData.giftSelect[giftindex][index - 1].option1 = optionEle.data("name");
    appData.giftSelect[giftindex][index - 1].sku = optionEle.data("sku");
    var items = $("#gift_option2_" + giftindex + "_" + index + ">.opt3");
    if (items.length > 0) {
        items.removeClass("active");
        items.addClass("disable");
        for (var i in appData.gifts[giftindex]) {
            var spec = appData.gifts[giftindex][i];
            if (spec.name + "" === appData.giftSelect[giftindex][index - 1].specname + "" && spec.option1 + "" === appData.giftSelect[giftindex][index - 1].option1 + "") {
                $.each(items, function (J, span) {
                    if ($(span).data("name") + "" === spec.option2 + "") {
                        var item = $(items[J]);
                        item.data("price", spec.price);
                        item.data("sku", spec.id);
                        item.removeClass("disable")
                    }
                })
            }
        }
        var option2_li = $(items.not(".disable"));
        if (option2_li.length === 0) {
            appData.giftSelect[giftindex][index - 1].price = optionEle.data("price");
            appData.giftSelect[giftindex][index - 1].sku = optionEle.data("sku")
        } else if (option2_li.length === 1) {
            appData.giftSelect[giftindex][index - 1].sku = "";
            appData.giftSelect[giftindex][index - 1].option2 = "";
            option2_li.click();
            return false
        } else {
            appData.giftSelect[giftindex][index - 1].sku = "";
            appData.giftSelect[giftindex][index - 1].option2 = ""
        }
    } else {
        $.each(appData.gifts, function (i, spec) {
            if (spec.name + "" === "" + appData.giftSelect[giftindex][index - 1].specname && spec.option1 + "" === "" + appData.giftSelect[giftindex][index - 1].option1) {
                appData.giftSelect[giftindex][index - 1].price = spec.price;
                return false
            }
        })
    }
}

function select_giftoption2(ele, giftindex, index) {
    var optionEle = $(ele);
    if (appData.giftSelect[giftindex][index - 1].option2 === optionEle.data("name")) return;
    if (optionEle.hasClass("disable")) return;
    optionEle.siblings(".opt3").removeClass("active");
    optionEle.addClass("active");
    appData.giftSelect[giftindex][index - 1].option2 = optionEle.data("name");
    appData.giftSelect[giftindex][index - 1].sku = optionEle.data("sku");
    $.each(appData.gifts[giftindex], function (i, spec) {
        if (spec.name + "" === appData.giftSelect[giftindex][index - 1].specname + "" && spec.option1 + "" === appData.giftSelect[giftindex][index - 1].option1 + "" && spec.option2 + "" === appData.giftSelect[giftindex][index - 1].option2 + "") {
            appData.giftSelect[giftindex][index - 1].price = spec.price;
            return false
        }
    })
}

function defaultSelected() {
    var gifts = $(".gifts");
    var length = parseInt(gifts.length);
    var isdefault = 0;
    for (var i in appData.gifts) {
        for (var j in appData.gifts[i]) {
            var spec = appData.gifts[i][j];
            if (spec.isdefault) {
                isdefault = spec.isdefault;
                var sku = spec.id;
                var items = gifts.eq(length - 1).children().eq(i).find(".opt1");
                $.each(items, function (index, span) {
                    if ($(span).data("id") === sku) {
                        $(this).click();
                        return false
                    }
                })
            }
        }
    }
}

$(function () {
    var isdefault = 0;
    for (var i in appData.goods.specs) {
        var spec = appData.goods.specs[i];
        if (spec.isdefault) {
            isdefault = spec.isdefault;
            var sku = spec.id;
            var items = $("#product-spec .opt1");
            $.each(items, function (index, span) {
                if ($(span).data("id") === sku) {
                    $(this).click();
                    return false
                }
            })
        }
    }
    if (appData.goods.count_info && appData.goods.count_info[0]) {
        $(".product_item").eq(0).find(".spec_Title i").text(appData.goods.count_info[0].name)
    }
});
$.get("./product/style02/salerecord/" + appData.language + ".json").success(function (data) {
    var marqueeContainer = $("#marqueeContainer");
    setTimeout(function () {
        marqueeContainer.empty();
        var li = "";
        for (var i in data) {
            li += '<li><div style="background-image: url(http://shop.static.zxkf.cc/spa/theme/' + data[i].img + ')">' + data[i].info + "</div></li>"
        }
        marqueeContainer.append(li);
        setInterval(function () {
            doscroll()
        }, 2e3)
    }, 0)
});

function doscroll() {
    var parent = $("#marqueeContainer");
    var first = parent.find("li:first");
    var height = parseInt(first.height()) + 30;
    first.animate({marginTop: -height + "px"}, 1e3, function () {
        first.css("marginTop", 0).appendTo(parent)
    })
}

var orderdata = sessionStorage.getItem("orderData");
if (orderdata && window.location.href.indexOf("?paypal=") > -1) {
    orderdata = JSON.parse(orderdata);
    var paypalButton = $("#paypal-button");
    var continue1 = $("#continue");
    var payment = $("#payment");
    var ordersuccess = $("#ordersuccess");
    var order_buygoods = $("#order_buygoods");
    for (var i in orderdata.goods) {
        var prods = orderdata.goods[i];
        order_buygoods.append('<li class="ordergoods_list" style="padding: 8px 0;border-bottom: 1px solid #ddd;margin: 0"><img class="ordergoods_img" style="width: 50px;height: 50px;vertical-align: middle;border: 1px solid #ccc;padding: 5px;margin-right: 10px;" src="' + appData.imgpath + prods.img + '-101"><span class="ordergoods_opt" style="display: inline-block;width: 40%;vertical-align: top;">' + prods.name + " " + prods.option1 + " " + prods.option2 + " " + appData.money + prods.price + " * " + '<span style="color: red;">' + prods.number + '</span></span><span class="ordergoods_subtotal" style="float: right;vertical-align: top;display: inline-block;">' + subtotal + ":" + appData.money + prods.price * prods.number + "</span></li>")
    }
    if (orderdata.gifts && orderdata.gifts.length > 0) {
        for (var m in appData.giftSelect) {
            if (appData.giftSelect[m].specname) {
                var giftgoods = appData.giftSelect[m];
                for (var n in giftgoods) {
                    var gifts = giftgoods[n];
                    order_buygoods.append('<li class="ordergoods_list" style="padding: 8px 0;border-bottom: 1px solid #ddd;margin: 0"><img class="ordergoods_img" style="width: 50px;height: 50px;vertical-align: middle;border: 1px solid #ccc;padding: 5px;margin-right: 10px;" src="' + appData.imgpath + gifts.img + '-101"><span class="ordergoods_opt" style="display: inline-block;width: 40%;vertical-align: top;">' + gifts.name + " " + gifts.option1 + " " + gifts.option2 + " " + appData.money + gifts.price + " * " + '<span style="color: red;">' + gifts.number + '</span></span><span class="ordergoods_subtotal" style="float: right;vertical-align: top;display: inline-block;"><del>' + subtotal + ":" + appData.money + prods.price * prods.number + '</del>  <span style="color: red">' + present + "</span></span></li>")
                }
            }
        }
    }
    $("#orderid").text(orderdata.orderInfo.orderid);
    $("#order_clientname").text(orderdata.orderInfo.clientname);
    $("#order_clientaddress").text(orderdata.orderInfo.clientaddress);
    $("#order_clientphone").text(orderdata.orderInfo.orderphone);
    $("#orderprice").text(appData.money + "" + orderdata.orderInfo.orderprice);
    $("#cardWin").hide();
    paypalButton.hide();
    continue1.show();
    payment.hide();
    ordersuccess.show();
    if (window.location.href.indexOf("paypal=cancel") > -1) {
        var orderPrice = orderdata.orderInfo.orderprice;
        var currency = "TWD";
        if (appData.money === "RM") currency = "MYR"; else if (appData.money === "HK") currency = "HKD"; else if (appData.money === "S$") currency = "SGD"; else if (appData.money === "฿") currency = "THB";
        var order_clientname = orderdata.orderInfo.clientname;
        var order_id = orderdata.orderInfo.orderid;
        var host = window.location.origin + "/api/shop/paypalPayment";
        var returnurl = window.location.origin + "/" + appData.sitedir + "?paypal=success";
        var cancelurl = window.location.origin + "/" + appData.sitedir + "?paypal=cancel";
        var formhtml = ' <form action="https://www.paypal.com/cgi-bin/webscr" method="post" id="sform">' + '<input type="hidden" name="cmd" value="_xclick">' + '<input type="hidden" name="business" value=' + appData.clientId + ">" + '<input type="hidden" name="item_name"  value=' + appData.goods.name + ">" + '<input id="amount" type="hidden" name="amount" value=' + orderPrice + ">" + '<input type="hidden" name="currency_code" value=' + currency + ">" + '<input type="hidden" name="return" value=' + returnurl + ">" + '<input type="hidden" name="notify_url" value=' + host + ">" + '<input type="hidden" name="cancel_return" value=' + cancelurl + ">" + '<input id="invoice" type="hidden" name="invoice" value=' + order_id + ">" + '<input type="hidden" name="charset" value="utf-8">' + '<input type="hidden" name="no_shipping" value="1">' + '<input type="hidden" name="no_note" value=' + order_clientname + ">" + '<input type="hidden" name="bn" value="IC_Sample">' + '<button id="paypal" type="submit" style="border-radius: 5px;border: #ffc439;cursor: pointer;background-color: #ffc439;"><img style="width:70px;" src="https://shop.static.zxkf.cc/paypal.svg"></button>' + "</form>";
        paypalButton.append(formhtml);
        paypalButton.show();
        continue1.hide();
        payment.show();
        ordersuccess.hide()
    }
    show_successwin()
}/**/